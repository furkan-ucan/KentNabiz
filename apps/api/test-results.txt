
> api@0.0.1 test:e2e C:\Users\furka\KentNabiz\apps\api
> jest --config ./test/jest-e2e.json

üåç Global E2E Setup - Running migrations and seeding data...
üßπ Cleaning test database schema...
‚úÖ Test database schema cleaned successfully.
üîÑ Running migrations on test database...
‚úÖ Migrations completed successfully.
Executed migrations:
  - FinalizeCoreSchemaAndConstraints20240601120000
  - AddSupportCountColumn1748148200000
Total executed: 2 migrations.
üå± Seeding test data globally...
‚úÖ Test data seeded successfully
‚úÖ Global test data seeded successfully.
üéâ Global E2E Setup completed successfully!
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 403 Final Response Payload: {"statusCode":403,"message":"Insufficient permissions.","error":"ForbiddenException","timestamp":"2025-05-27T22:24:52.328Z","path":"/reports/93/assign-team/1"} Path: /reports/93/assign-team/1 Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mForbiddenException: Insufficient permissions.
    at RolesGuard.canActivate (C:\Users\furka\KentNabiz\apps\api\src\modules\auth\guards\roles.guard.ts:59:13)
    at GuardsConsumer.tryActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\guards\guards-consumer.js:15:34)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at canActivateFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:135:33)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:42:31
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-proxy.js:9:17[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 403 Final Response Payload: {"statusCode":403,"message":"Insufficient permissions.","error":"ForbiddenException","timestamp":"2025-05-27T22:24:52.346Z","path":"/reports/93/status"} Path: /reports/93/status Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mForbiddenException: Insufficient permissions.
    at RolesGuard.canActivate (C:\Users\furka\KentNabiz\apps\api\src\modules\auth\guards\roles.guard.ts:59:13)
    at GuardsConsumer.tryActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\guards\guards-consumer.js:15:34)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at canActivateFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:135:33)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:42:31
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-proxy.js:9:17[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 401 Final Response Payload: {"statusCode":401,"message":"Unauthorized","error":"UnauthorizedException","timestamp":"2025-05-27T22:24:52.355Z","path":"/reports/93"} Path: /reports/93 Method: GET[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mUnauthorizedException: Unauthorized
    at JwtAuthGuard.handleRequest (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:60:30)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:44:124
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:83:24
    at allFailed (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:110:18)
    at attempt (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:183:28)
    at JwtStrategy.strategy.fail (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:314:9)
    at JwtStrategy.Object.<anonymous>.JwtStrategy.authenticate (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport-jwt@4.0.1\node_modules\passport-jwt\lib\strategy.js:96:21)
    at attempt (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:378:16)
    at authenticate (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:379:7)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:88:3
    at new Promise (<anonymous>)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:80:83
    at JwtAuthGuard.canActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:44:32)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 400 Final Response Payload: {"statusCode":400,"message":"title should not be empty; Invalid value; reportType must be one of the following values: POTHOLE, ROAD_DAMAGE, ROAD_SIGN, ROAD_MARKING, ROAD_CONSTRUCTION, ROAD_MAINTENANCE, ROAD_CLEANING, ROAD_REPAIR, ROAD_BLOCK, TRAFFIC_LIGHT, STREET_LIGHT, ELECTRICITY_OUTAGE, WATER_LEAKAGE, LITTER, GRAFFITI, PARK_DAMAGE, TREE_ISSUE, PARKING_VIOLATION, PUBLIC_TRANSPORT, PUBLIC_TRANSPORT_VIOLATION, PUBLIC_TRANSPORT_STOP, PUBLIC_TRANSPORT_VEHICLE, GARBAGE_COLLECTION, OTHER","error":"BadRequestException","timestamp":"2025-05-27T22:24:52.376Z","path":"/reports"} Path: /reports Method: POST[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mBadRequestException: Validation failed
    at ValidationPipe.transform (C:\Users\furka\KentNabiz\apps\api\src\core\pipes\validation.pipe.ts:19:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\pipes\pipes-consumer.js:15:25
    at resolveParamValue (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:148:23)
    at async Promise.all (index 1)
    at pipesFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:151:13)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:37:30[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 400 Final Response Payload: {"statusCode":400,"message":"newStatus must be one of the following values: OPEN, IN_REVIEW, IN_PROGRESS, DONE, REJECTED, CANCELLED","error":"BadRequestException","timestamp":"2025-05-27T22:24:52.392Z","path":"/reports/93/status"} Path: /reports/93/status Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mBadRequestException: Validation failed
    at ValidationPipe.transform (C:\Users\furka\KentNabiz\apps\api\src\core\pipes\validation.pipe.ts:19:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\pipes\pipes-consumer.js:15:25
    at resolveParamValue (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:148:23)
    at async Promise.all (index 1)
    at pipesFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:151:13)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:37:30[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 404 Final Response Payload: {"statusCode":404,"message":"Team with ID 99999 not found.","error":"NotFoundException","timestamp":"2025-05-27T22:24:52.411Z","path":"/reports/93/assign-team/99999"} Path: /reports/93/assign-team/99999 Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:52 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mNotFoundException: Team with ID 99999 not found.
    at TeamsService.findOne (C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:202:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at ReportsController.assignReportToTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\reports\controllers\reports.controller.ts:360:5)[39m
HttpExceptionFilter
PASS test/report-lifecycle.e2e-spec.ts (5.787 s)
  ‚óè Console

    console.log
      üß™ Setting up E2E test environment...

      at Object.<anonymous> (test/setup-e2e.ts:7:11)

    console.log
      ‚úÖ E2E test environment ready (using globally seeded data).

      at Object.<anonymous> (test/setup-e2e.ts:15:11)

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384691650"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.create on path /reports

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports, Required Roles: CITIZEN, SYSTEM_ADMIN, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 1 with roles [CITIZEN] has required role for /reports. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384691872"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.findOne on path /reports/93

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, CITIZEN, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 1 with roles [CITIZEN] has required role for /reports/93. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [findOne] AuthUser: {"sub":1,"email":"citizen@test.com","roles":["CITIZEN"],"departmentId":null,"jti":"test-1-1748384691872"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"OPEN","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:51.720Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":1,"email":"citizen@test.com","roles":["CITIZEN"],"departmentId":null,"jti":"test-1-1748384691872"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"OPEN","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:51.720Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384691909"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.updateStatus on path /reports/93/status

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/status, Required Roles: DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/93/status. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [ReportsService.updateStatus] Entry - Report ID: 93, User ID: 3, User Email: supervisor@test.com, User Active Team ID: undefined, New Status: IN_REVIEW, New SubStatus: undefined

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:344:13)

    console.log
      [ReportsService.updateStatus] ABAC Check - User: 3, Report: 93, NextStatus: IN_REVIEW

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:408:13)

    console.log
      [ReportsService.updateStatus] UserForAbility: {
        "id": 3,
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:411:13)

    console.log
      [ReportsService.updateStatus] ReportForAuthCheck: {
        "id": 93,
        "status": "OPEN",
        "subStatus": null,
        "currentDepartmentId": 1,
        "userId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:415:13)

    console.log
      [ReportsService.updateStatus] Checking Action.Update permission

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:465:15)

    console.log
      [ReportsService.updateStatus] Transaction started for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:479:15)

    console.log
      [ReportsService.updateStatus] Locked report 93 and its relations loaded within transaction.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:494:15)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384691909"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"OPEN","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:51.720Z","resolvedAt":null,"subStatus":null,"supportCount":0,"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"assignments":[]}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: change_status

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: change_status

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [ReportsService.updateStatus] Transaction committed for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:625:15)

    console.log
      [ReportsService.updateStatus] Releasing query runner for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:646:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384691996"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.assignReportToTeam on path /reports/93/assign-team/1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/assign-team/1, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/93/assign-team/1. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 1 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 1 found: Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 1 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 1 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [ReportsService.assignReportToTeam] New assignment created: ID 64, Report ID 93, Team ID 1, AcceptedAt: 2025-05-27T22:24:52.049Z

      at ReportsService.assignReportToTeam (src/modules/reports/services/reports.service.ts:897:15)

    console.log
      [ReportsService.assignReportToTeam] Report 93 status unchanged (IN_REVIEW), only assignment created.

      at ReportsService.assignReportToTeam (src/modules/reports/services/reports.service.ts:937:17)

    console.log
      [findOne] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384691996"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:51.950Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384691996"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:51.950Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [LIFECYCLE_TEST_START_WORK] Report ID: 93, Team ID for assignment check: 1

      at Object.<anonymous> (test/report-lifecycle.e2e-spec.ts:137:15)

    console.log
      [AuthHelper.generateToken] Creating token for user 2 (team.member@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 2,
        "email": "team.member@test.com",
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1,
        "jti": "test-2-1748384692079"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.updateStatus on path /reports/93/status

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/status, Required Roles: DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN, User Roles: TEAM_MEMBER

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 2 with roles [TEAM_MEMBER] has required role for /reports/93/status. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [ReportsService.updateStatus] Entry - Report ID: 93, User ID: 2, User Email: team.member@test.com, User Active Team ID: 1, New Status: IN_PROGRESS, New SubStatus: undefined

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:344:13)

    console.log
      [ReportsService.updateStatus] TEAM_MEMBER (ID: 2, ActiveTeamID: 1) attempting to update status for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:356:15)

    console.log
      [ReportsService.updateStatus] Report assignments for report 93 (for active check): [{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:360:15)

    console.log
      [ReportsService.updateStatus] Checking assignment ID 64: assigneeType=TEAM, assigneeUserId=null, assigneeTeamId=1, status=ACTIVE, acceptedAt=2025-05-27T22:24:52.049Z, isUserMatch=false, isTeamMatch=true, isActive=true, isAccepted=true

      at src/modules/reports/services/reports.service.ts:375:19
          at Array.some (<anonymous>)

    console.log
      [ReportsService.updateStatus] TEAM_MEMBER hasActiveAssignment: true for report 93. User: 2, ActiveTeam: 1

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:389:15)

    console.log
      [ReportsService.updateStatus] ABAC Check - User: 2, Report: 93, NextStatus: IN_PROGRESS

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:408:13)

    console.log
      [ReportsService.updateStatus] UserForAbility: {
        "id": 2,
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:411:13)

    console.log
      [ReportsService.updateStatus] ReportForAuthCheck: {
        "id": 93,
        "status": "IN_REVIEW",
        "subStatus": null,
        "currentDepartmentId": 1,
        "userId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:415:13)

    console.log
      [ReportsService.updateStatus] Checking Action.Update permission

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:465:15)

    console.log
      [ReportsService.updateStatus] Transaction started for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:479:15)

    console.log
      [ReportsService.updateStatus] Locked report 93 and its relations loaded within transaction.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:494:15)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":2,"email":"team.member@test.com","roles":["TEAM_MEMBER"],"departmentId":1,"activeTeamId":1,"jti":"test-2-1748384692079"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:51.950Z","resolvedAt":null,"subStatus":null,"supportCount":0,"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: change_status

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [ReportsService.updateStatus] Transaction committed for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:625:15)

    console.log
      [ReportsService.updateStatus] Releasing query runner for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:646:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 2 (team.member@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 2,
        "email": "team.member@test.com",
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1,
        "jti": "test-2-1748384692149"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.updateStatus on path /reports/93/status

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/status, Required Roles: DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN, User Roles: TEAM_MEMBER

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 2 with roles [TEAM_MEMBER] has required role for /reports/93/status. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [ReportsService.updateStatus] Entry - Report ID: 93, User ID: 2, User Email: team.member@test.com, User Active Team ID: 1, New Status: DONE, New SubStatus: undefined

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:344:13)

    console.log
      [ReportsService.updateStatus] TEAM_MEMBER (ID: 2, ActiveTeamID: 1) attempting to update status for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:356:15)

    console.log
      [ReportsService.updateStatus] Report assignments for report 93 (for active check): [{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:360:15)

    console.log
      [ReportsService.updateStatus] Checking assignment ID 64: assigneeType=TEAM, assigneeUserId=null, assigneeTeamId=1, status=ACTIVE, acceptedAt=2025-05-27T22:24:52.049Z, isUserMatch=false, isTeamMatch=true, isActive=true, isAccepted=true

      at src/modules/reports/services/reports.service.ts:375:19
          at Array.some (<anonymous>)

    console.log
      [ReportsService.updateStatus] TEAM_MEMBER hasActiveAssignment: true for report 93. User: 2, ActiveTeam: 1

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:389:15)

    console.log
      [ReportsService.updateStatus] ABAC Check - User: 2, Report: 93, NextStatus: DONE

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:408:13)

    console.log
      [ReportsService.updateStatus] UserForAbility: {
        "id": 2,
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:411:13)

    console.log
      [ReportsService.updateStatus] ReportForAuthCheck: {
        "id": 93,
        "status": "IN_PROGRESS",
        "subStatus": null,
        "currentDepartmentId": 1,
        "userId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:415:13)

    console.log
      [ReportsService.updateStatus] Checking Action.CompleteWork permission for TEAM_MEMBER

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:441:15)

    console.log
      [ReportsService.updateStatus] Transaction started for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:479:15)

    console.log
      [ReportsService.updateStatus] Locked report 93 and its relations loaded within transaction.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:494:15)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":2,"email":"team.member@test.com","roles":["TEAM_MEMBER"],"departmentId":1,"activeTeamId":1,"jti":"test-2-1748384692149"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_PROGRESS","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:52.115Z","resolvedAt":null,"subStatus":null,"supportCount":0,"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: change_status

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [ReportsService.updateStatus] Transaction committed for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:625:15)

    console.log
      [ReportsService.updateStatus] Releasing query runner for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:646:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384692216"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.updateStatus on path /reports/93/status

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/status, Required Roles: DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/93/status. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [ReportsService.updateStatus] Entry - Report ID: 93, User ID: 3, User Email: supervisor@test.com, User Active Team ID: undefined, New Status: DONE, New SubStatus: undefined

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:344:13)

    console.log
      [ReportsService.updateStatus] ABAC Check - User: 3, Report: 93, NextStatus: DONE

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:408:13)

    console.log
      [ReportsService.updateStatus] UserForAbility: {
        "id": 3,
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:411:13)

    console.log
      [ReportsService.updateStatus] ReportForAuthCheck: {
        "id": 93,
        "status": "IN_PROGRESS",
        "subStatus": "PENDING_APPROVAL",
        "currentDepartmentId": 1,
        "userId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:415:13)

    console.log
      [ReportsService.updateStatus] Checking Action.Approve permission for DEPARTMENT_SUPERVISOR

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:452:15)

    console.log
      [ReportsService.updateStatus] Transaction started for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:479:15)

    console.log
      [ReportsService.updateStatus] Locked report 93 and its relations loaded within transaction.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:494:15)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384692216"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_PROGRESS","currentDepartmentId":1,"resolutionNotes":"Filled the pothole with asphalt and compacted properly","rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:52.181Z","resolvedAt":null,"subStatus":"PENDING_APPROVAL","supportCount":0,"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: change_status

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: change_status

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [ReportsService.updateStatus] Transaction committed for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:625:15)

    console.log
      [ReportsService.updateStatus] Releasing query runner for report 93.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:646:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384692281"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.getStatusHistory on path /reports/93/status-history

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/status-history, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/93/status-history. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [findOne] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384692281"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"DONE","currentDepartmentId":1,"resolutionNotes":"Filled the pothole with asphalt and compacted properly","rejectionReason":null,"userId":1,"closedByUserId":3,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:52.246Z","resolvedAt":"2025-05-27T22:24:52.251Z","subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384692281"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"DONE","currentDepartmentId":1,"resolutionNotes":"Filled the pothole with asphalt and compacted properly","rejectionReason":null,"userId":1,"closedByUserId":3,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:52.246Z","resolvedAt":"2025-05-27T22:24:52.251Z","subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384692315"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.assignReportToTeam on path /reports/93/assign-team/1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/assign-team/1, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.warn
      [RolesGuard] User 1 with roles [CITIZEN] does NOT have required roles [DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER] for /reports/93/assign-team/1. Denying access.

    [0m [90m 54 |[39m
     [90m 55 |[39m     [36mif[39m ([33m![39mhasRequiredRole) {
    [31m[1m>[22m[39m[90m 56 |[39m       console[33m.[39mwarn(
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 57 |[39m         [32m`[RolesGuard] User ${user.sub} with roles [${user.roles.join(', ')}] does NOT have required roles [${requiredRoles.join(', ')}] for ${request.url}. Denying access.`[39m
     [90m 58 |[39m       )[33m;[39m
     [90m 59 |[39m       [36mthrow[39m [36mnew[39m [33mForbiddenException[39m([32m'Insufficient permissions.'[39m)[33m;[39m[0m

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:56:15)
      at GuardsConsumer.tryActivate (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/guards/guards-consumer.js:15:34)
      at canActivateFn (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:135:33)
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:42:31
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-proxy.js:9:17

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384692337"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.updateStatus on path /reports/93/status

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/status, Required Roles: DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.warn
      [RolesGuard] User 1 with roles [CITIZEN] does NOT have required roles [DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN] for /reports/93/status. Denying access.

    [0m [90m 54 |[39m
     [90m 55 |[39m     [36mif[39m ([33m![39mhasRequiredRole) {
    [31m[1m>[22m[39m[90m 56 |[39m       console[33m.[39mwarn(
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 57 |[39m         [32m`[RolesGuard] User ${user.sub} with roles [${user.roles.join(', ')}] does NOT have required roles [${requiredRoles.join(', ')}] for ${request.url}. Denying access.`[39m
     [90m 58 |[39m       )[33m;[39m
     [90m 59 |[39m       [36mthrow[39m [36mnew[39m [33mForbiddenException[39m([32m'Insufficient permissions.'[39m)[33m;[39m[0m

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:56:15)
      at GuardsConsumer.tryActivate (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/guards/guards-consumer.js:15:34)
      at canActivateFn (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:135:33)
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:42:31
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-proxy.js:9:17

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384692363"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.create on path /reports

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports, Required Roles: CITIZEN, SYSTEM_ADMIN, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 1 with roles [CITIZEN] has required role for /reports. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384692382"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.updateStatus on path /reports/93/status

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/status, Required Roles: DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/93/status. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384692398"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.assignReportToTeam on path /reports/93/assign-team/99999

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/assign-team/99999, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/93/assign-team/99999. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 99999 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.warn
      [TeamsService.findOne] Team with ID 99999 not found in repository.

    [0m [90m 199 |[39m
     [90m 200 |[39m     [36mif[39m ([33m![39mteam) {
    [31m[1m>[22m[39m[90m 201 |[39m       console[33m.[39mwarn([32m`[TeamsService.findOne] Team with ID ${id} not found in repository.`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 202 |[39m       [36mthrow[39m [36mnew[39m [33mNotFoundException[39m([32m`Team with ID ${id} not found.`[39m)[33m;[39m
     [90m 203 |[39m     }
     [90m 204 |[39m     console[33m.[39mlog([0m

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:201:15)
      at ReportsController.assignReportToTeam (src/modules/reports/controllers/reports.controller.ts:360:5)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384692430"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.forwardReport on path /reports/93/forward

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/forward, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/93/forward. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384692430"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"DONE","currentDepartmentId":1,"resolutionNotes":"Filled the pothole with asphalt and compacted properly","rejectionReason":null,"userId":1,"closedByUserId":3,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:52.246Z","resolvedAt":"2025-05-27T22:24:52.251Z","subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: forward

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: forward

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [ReportsService.forwardReport] Transaction started for report 93.

      at ReportsService.forwardReport (src/modules/reports/services/reports.service.ts:1028:15)

    console.log
      [ReportsService.forwardReport] Transaction committed for report 93.

      at ReportsService.forwardReport (src/modules/reports/services/reports.service.ts:1096:15)

    console.log
      [ReportsService.forwardReport] Releasing query runner for report 93.

      at ReportsService.forwardReport (src/modules/reports/services/reports.service.ts:1121:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384692489"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.getDepartmentHistory on path /reports/93/history

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/93/history, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/93/history. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [findOne] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384692489"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"DONE","currentDepartmentId":1,"resolutionNotes":"Filled the pothole with asphalt and compacted properly","rejectionReason":null,"userId":1,"closedByUserId":3,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:52.451Z","resolvedAt":"2025-05-27T22:24:52.251Z","subStatus":"FORWARDED","supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"CANCELLED","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":"2025-05-27T22:24:52.468Z","rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384692489"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":93,"title":"Large pothole on Main Street","description":"There is a dangerous pothole that needs immediate attention","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"DONE","currentDepartmentId":1,"resolutionNotes":"Filled the pothole with asphalt and compacted properly","rejectionReason":null,"userId":1,"closedByUserId":3,"createdAt":"2025-05-27T19:24:51.752Z","updatedAt":"2025-05-27T19:24:52.451Z","resolvedAt":"2025-05-27T22:24:52.251Z","subStatus":"FORWARDED","supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":64,"reportId":93,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"CANCELLED","assignedAt":"2025-05-27T22:24:52.049Z","acceptedAt":"2025-05-27T22:24:52.049Z","completedAt":"2025-05-27T22:24:52.468Z","rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384692527"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.findAll on path /reports?page=1&limit=10&status=DONE&reportType=POTHOLE

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports?page=1&limit=10&status=DONE&reportType=POTHOLE, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports?page=1&limit=10&status=DONE&reportType=POTHOLE. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384692564"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.findNearby on path /reports/nearby?latitude=41.0&longitude=29.0&radius=1000

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/nearby?latitude=41.0&longitude=29.0&radius=1000, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, CITIZEN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/nearby?latitude=41.0&longitude=29.0&radius=1000. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384692601"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.getMyReports on path /reports/my-reports

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/my-reports, Required Roles: CITIZEN, TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 1 with roles [CITIZEN] has required role for /reports/my-reports. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      üßπ E2E test environment cleaned up

      at Object.<anonymous> (test/setup-e2e.ts:19:11)

[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 403 Final Response Payload: {"statusCode":403,"message":"Insufficient permissions.","error":"ForbiddenException","timestamp":"2025-05-27T22:24:54.123Z","path":"/teams"} Path: /teams Method: POST[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mForbiddenException: Insufficient permissions.
    at RolesGuard.canActivate (C:\Users\furka\KentNabiz\apps\api\src\modules\auth\guards\roles.guard.ts:59:13)
    at GuardsConsumer.tryActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\guards\guards-consumer.js:15:34)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at canActivateFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:135:33)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:42:31
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-proxy.js:9:17[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 403 Final Response Payload: {"statusCode":403,"message":"Insufficient permissions.","error":"ForbiddenException","timestamp":"2025-05-27T22:24:54.143Z","path":"/teams/100/members/3"} Path: /teams/100/members/3 Method: POST[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mForbiddenException: Insufficient permissions.
    at RolesGuard.canActivate (C:\Users\furka\KentNabiz\apps\api\src\modules\auth\guards\roles.guard.ts:59:13)
    at GuardsConsumer.tryActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\guards\guards-consumer.js:15:34)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at canActivateFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:135:33)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:42:31
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-proxy.js:9:17[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 401 Final Response Payload: {"statusCode":401,"message":"Unauthorized","error":"UnauthorizedException","timestamp":"2025-05-27T22:24:54.184Z","path":"/teams/100"} Path: /teams/100 Method: GET[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mUnauthorizedException: Unauthorized
    at JwtAuthGuard.handleRequest (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:60:30)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:44:124
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:83:24
    at allFailed (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:110:18)
    at attempt (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:183:28)
    at JwtStrategy.strategy.fail (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:314:9)
    at JwtStrategy.Object.<anonymous>.JwtStrategy.authenticate (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport-jwt@4.0.1\node_modules\passport-jwt\lib\strategy.js:96:21)
    at attempt (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:378:16)
    at authenticate (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:379:7)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:88:3
    at new Promise (<anonymous>)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:80:83
    at JwtAuthGuard.canActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:44:32)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 400 Final Response Payload: {"statusCode":400,"message":"name should not be empty; departmentId must be an integer number; teamLeaderId must be an integer number; Invalid value","error":"BadRequestException","timestamp":"2025-05-27T22:24:54.204Z","path":"/teams"} Path: /teams Method: POST[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mBadRequestException: Validation failed
    at ValidationPipe.transform (C:\Users\furka\KentNabiz\apps\api\src\core\pipes\validation.pipe.ts:19:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\pipes\pipes-consumer.js:15:25
    at resolveParamValue (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:148:23)
    at async Promise.all (index 1)
    at pipesFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:151:13)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:37:30[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 400 Final Response Payload: {"statusCode":400,"message":"status must be one of the following values: AVAILABLE, ON_DUTY, OFF_DUTY, INACTIVE","error":"BadRequestException","timestamp":"2025-05-27T22:24:54.230Z","path":"/teams/100"} Path: /teams/100 Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mBadRequestException: Validation failed
    at ValidationPipe.transform (C:\Users\furka\KentNabiz\apps\api\src\core\pipes\validation.pipe.ts:19:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\pipes\pipes-consumer.js:15:25
    at resolveParamValue (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:148:23)
    at async Promise.all (index 1)
    at pipesFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:151:13)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:37:30[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 404 Final Response Payload: {"statusCode":404,"message":"User with ID 99999 not found.","error":"NotFoundException","timestamp":"2025-05-27T22:24:54.267Z","path":"/teams/100/members/99999"} Path: /teams/100/members/99999 Method: POST[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mNotFoundException: User with ID 99999 not found.
    at C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:319:15
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at EntityManager.transaction (C:\Users\furka\KentNabiz\node_modules\.pnpm\typeorm@0.3.21_ioredis@5.6._e3b7d879b4c41320d7a731c639c18759\src\entity-manager\EntityManager.ts:154:28)
    at TeamsService.addMemberToTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:308:5)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 404 Final Response Payload: {"statusCode":404,"message":"Specialization with ID 99999 not found.","error":"NotFoundException","timestamp":"2025-05-27T22:24:54.307Z","path":"/teams/100/specializations/99999"} Path: /teams/100/specializations/99999 Method: POST[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mNotFoundException: Specialization with ID 99999 not found.
    at TeamsService.addSpecializationToTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:443:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 400 Final Response Payload: {"statusCode":400,"message":"lat must not be greater than 90, lat must not be less than -90, lat must be a number conforming to the specified constraints","error":"BadRequestException","timestamp":"2025-05-27T22:24:54.325Z","path":"/teams/nearby?lat=invalid&lng=29.0"} Path: /teams/nearby?lat=invalid&lng=29.0 Method: GET[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mBadRequestException: Validation failed
    at ValidationPipe.transform (C:\Users\furka\KentNabiz\apps\api\src\core\pipes\validation.pipe.ts:19:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\pipes\pipes-consumer.js:15:25
    at resolveParamValue (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:148:23)
    at async Promise.all (index 0)
    at pipesFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:151:13)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:37:30[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 404 Final Response Payload: {"statusCode":404,"message":"Team with ID 100 not found.","error":"NotFoundException","timestamp":"2025-05-27T22:24:54.393Z","path":"/teams/100"} Path: /teams/100 Method: GET[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mNotFoundException: Team with ID 100 not found.
    at TeamsService.findOne (C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:202:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 404 Final Response Payload: {"statusCode":404,"message":"Team with ID 99999 not found.","error":"NotFoundException","timestamp":"2025-05-27T22:24:54.413Z","path":"/teams/99999"} Path: /teams/99999 Method: DELETE[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mNotFoundException: Team with ID 99999 not found.
    at TeamsService.findOne (C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:202:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at TeamsService.remove (C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:272:18)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 400 Final Response Payload: {"statusCode":400,"message":"Validation failed (numeric string is expected)","error":"BadRequestException","timestamp":"2025-05-27T22:24:54.429Z","path":"/teams/not-a-number"} Path: /teams/not-a-number Method: GET[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:54 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mBadRequestException: Validation failed (numeric string is expected)
    at ParseIntPipe.exceptionFactory (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+common@11.0.12_clas_a2af2bac15e3834d3db5565fc45d57a7\node_modules\@nestjs\common\pipes\parse-int.pipe.js:24:27)
    at ParseIntPipe.transform (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+common@11.0.12_clas_a2af2bac15e3834d3db5565fc45d57a7\node_modules\@nestjs\common\pipes\parse-int.pipe.js:38:24)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\pipes\pipes-consumer.js:16:33
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at resolveParamValue (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:148:23)
    at async Promise.all (index 1)
    at pipesFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:151:13)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:37:30[39m
HttpExceptionFilter
PASS test/team-management.e2e-spec.ts
  ‚óè Console

    console.log
      üß™ Setting up E2E test environment...

      at Object.<anonymous> (test/setup-e2e.ts:7:11)

    console.log
      ‚úÖ E2E test environment ready (using globally seeded data).

      at Object.<anonymous> (test/setup-e2e.ts:15:11)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693571"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TEAM_CRUD_CREATE] Response status: 201

      at Object.<anonymous> (test/team-management.e2e-spec.ts:72:15)

    console.log
      [TEAM_CRUD_CREATE] Response body: {"data":{"name":"Emergency Response Team Alpha","departmentId":1,"teamLeaderId":3,"status":"AVAILABLE","baseLocation":{"type":"Point","coordinates":[29,41]},"currentLocation":null,"lastLocationUpdate":null,"id":100}}

      at Object.<anonymous> (test/team-management.e2e-spec.ts:73:15)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693645"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findOne on path /teams/100

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693670"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.update on path /teams/100

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693715"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findAll on path /teams?page=1&limit=10

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams?page=1&limit=10, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams?page=1&limit=10. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693753"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findTeamsByDepartment on path /teams/department/1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/department/1, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/department/1. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693796"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.addMemberToTeam on path /teams/100/members/3

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/members/3, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/members/3. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.addMemberToTeam] Attempting to add user 3 to team 100 by authUser 3 (DEPARTMENT_SUPERVISOR)

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:294:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.addMemberToTeam] Adding user 3 as an active member to new team 100.

      at src/modules/teams/services/teams.service.ts:371:15

    console.log
      [TeamsService.addMemberToTeam] User 3 successfully added to team 100 and membership history created.

      at src/modules/teams/services/teams.service.ts:379:15

    console.log
      [TeamsService.addMemberToTeam] Transaction completed. Fetching and returning updated team info for team 100.

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:387:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693843"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.getTeamMembers on path /teams/100/members

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/members, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/members. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693875"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.removeMemberFromTeam on path /teams/100/members/3

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/members/3, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/members/3. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693936"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.getTeamMembers on path /teams/100/members

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/members, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/members. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384693961"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.addSpecializationToTeam on path /teams/100/specializations/1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/specializations/1, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/specializations/1. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694011"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.getTeamSpecializations on path /teams/100/specializations

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/specializations, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/specializations. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694038"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.removeSpecializationFromTeam on path /teams/100/specializations/1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/specializations/1, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/specializations/1. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694070"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.getTeamSpecializations on path /teams/100/specializations

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/specializations, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/specializations. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694096"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findNearbyTeams on path /teams/nearby?lat=41.0&lng=29.0&specializationId=1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/nearby?lat=41.0&lng=29.0&specializationId=1, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/nearby?lat=41.0&lng=29.0&specializationId=1. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 2 (team.member@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 2,
        "email": "team.member@test.com",
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1,
        "jti": "test-2-1748384694116"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: TEAM_MEMBER

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.warn
      [RolesGuard] User 2 with roles [TEAM_MEMBER] does NOT have required roles [DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN] for /teams. Denying access.

    [0m [90m 54 |[39m
     [90m 55 |[39m     [36mif[39m ([33m![39mhasRequiredRole) {
    [31m[1m>[22m[39m[90m 56 |[39m       console[33m.[39mwarn(
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 57 |[39m         [32m`[RolesGuard] User ${user.sub} with roles [${user.roles.join(', ')}] does NOT have required roles [${requiredRoles.join(', ')}] for ${request.url}. Denying access.`[39m
     [90m 58 |[39m       )[33m;[39m
     [90m 59 |[39m       [36mthrow[39m [36mnew[39m [33mForbiddenException[39m([32m'Insufficient permissions.'[39m)[33m;[39m[0m

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:56:15)
      at GuardsConsumer.tryActivate (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/guards/guards-consumer.js:15:34)
      at canActivateFn (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:135:33)
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:42:31
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-proxy.js:9:17

    console.log
      [AuthHelper.generateToken] Creating token for user 2 (team.member@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 2,
        "email": "team.member@test.com",
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1,
        "jti": "test-2-1748384694133"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.addMemberToTeam on path /teams/100/members/3

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/members/3, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: TEAM_MEMBER

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.warn
      [RolesGuard] User 2 with roles [TEAM_MEMBER] does NOT have required roles [DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN] for /teams/100/members/3. Denying access.

    [0m [90m 54 |[39m
     [90m 55 |[39m     [36mif[39m ([33m![39mhasRequiredRole) {
    [31m[1m>[22m[39m[90m 56 |[39m       console[33m.[39mwarn(
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 57 |[39m         [32m`[RolesGuard] User ${user.sub} with roles [${user.roles.join(', ')}] does NOT have required roles [${requiredRoles.join(', ')}] for ${request.url}. Denying access.`[39m
     [90m 58 |[39m       )[33m;[39m
     [90m 59 |[39m       [36mthrow[39m [36mnew[39m [33mForbiddenException[39m([32m'Insufficient permissions.'[39m)[33m;[39m[0m

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:56:15)
      at GuardsConsumer.tryActivate (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/guards/guards-consumer.js:15:34)
      at canActivateFn (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:135:33)
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:42:31
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-proxy.js:9:17

    console.log
      [AuthHelper.generateToken] Creating token for user 4 (admin@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 4,
        "email": "admin@test.com",
        "roles": [
          "SYSTEM_ADMIN"
        ],
        "departmentId": null,
        "jti": "test-4-1748384694152"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findOne on path /teams/100

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /teams/100 to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 4 (admin@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 4 (Roles: SYSTEM_ADMIN, Dept: null) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] SYSTEM_ADMIN detected. Access granted.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:47:15)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 4: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694193"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694213"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.update on path /teams/100

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694238"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.addMemberToTeam on path /teams/100/members/99999

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/members/99999, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/members/99999. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.addMemberToTeam] Attempting to add user 99999 to team 100 by authUser 3 (DEPARTMENT_SUPERVISOR)

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:294:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.error
      [TeamsService.addMemberToTeam] User with ID 99999 not found.

    [0m [90m 316 |[39m       [90m// 3b. Kullanƒ±cƒ± varlƒ±k kontrol√º.[39m
     [90m 317 |[39m       [36mif[39m ([33m![39muser) {
    [31m[1m>[22m[39m[90m 318 |[39m         console[33m.[39merror([32m`[TeamsService.addMemberToTeam] User with ID ${userId} not found.`[39m)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 319 |[39m         [36mthrow[39m [36mnew[39m [33mNotFoundException[39m([32m`User with ID ${userId} not found.`[39m)[33m;[39m
     [90m 320 |[39m       }
     [90m 321 |[39m[0m

      at src/modules/teams/services/teams.service.ts:318:17
      at EntityManager.transaction (../../node_modules/.pnpm/typeorm@0.3.21_ioredis@5.6._e3b7d879b4c41320d7a731c639c18759/src/entity-manager/EntityManager.ts:154:28)
      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:308:5)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694284"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.addSpecializationToTeam on path /teams/100/specializations/99999

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100/specializations/99999, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100/specializations/99999. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694316"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findNearbyTeams on path /teams/nearby?lat=invalid&lng=29.0

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/nearby?lat=invalid&lng=29.0, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/nearby?lat=invalid&lng=29.0. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694332"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.remove on path /teams/100

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 100 found: Emergency Response Team Alpha - Updated. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 100 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 100 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694380"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findOne on path /teams/100

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/100, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/100. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 100 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.warn
      [TeamsService.findOne] Team with ID 100 not found in repository.

    [0m [90m 199 |[39m
     [90m 200 |[39m     [36mif[39m ([33m![39mteam) {
    [31m[1m>[22m[39m[90m 201 |[39m       console[33m.[39mwarn([32m`[TeamsService.findOne] Team with ID ${id} not found in repository.`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 202 |[39m       [36mthrow[39m [36mnew[39m [33mNotFoundException[39m([32m`Team with ID ${id} not found.`[39m)[33m;[39m
     [90m 203 |[39m     }
     [90m 204 |[39m     console[33m.[39mlog([0m

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:201:15)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694399"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.remove on path /teams/99999

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/99999, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/99999. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 99999 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.warn
      [TeamsService.findOne] Team with ID 99999 not found in repository.

    [0m [90m 199 |[39m
     [90m 200 |[39m     [36mif[39m ([33m![39mteam) {
    [31m[1m>[22m[39m[90m 201 |[39m       console[33m.[39mwarn([32m`[TeamsService.findOne] Team with ID ${id} not found in repository.`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 202 |[39m       [36mthrow[39m [36mnew[39m [33mNotFoundException[39m([32m`Team with ID ${id} not found.`[39m)[33m;[39m
     [90m 203 |[39m     }
     [90m 204 |[39m     console[33m.[39mlog([0m

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:201:15)
      at TeamsService.remove (src/modules/teams/services/teams.service.ts:272:18)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694420"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findOne on path /teams/not-a-number

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/not-a-number, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/not-a-number. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694436"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [CONCURRENT_TEST] Created newTeamId: 101 from response body: {"data":{"name":"Concurrent Test Team","departmentId":1,"teamLeaderId":3,"status":"AVAILABLE","baseLocation":{"type":"Point","coordinates":[29,41]},"currentLocation":null,"lastLocationUpdate":null,"id":101}}

      at Object.<anonymous> (test/team-management.e2e-spec.ts:440:15)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694468"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384694469"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.addMemberToTeam on path /teams/101/members/3

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/101/members/3, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/101/members/3. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.addMemberToTeam] Attempting to add user 3 to team 101 by authUser 3 (DEPARTMENT_SUPERVISOR)

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:294:13)

    console.log
      [TeamsService.findOne] Called for team ID: 101 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.addMemberToTeam on path /teams/101/members/3

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/101/members/3, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/101/members/3. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.addMemberToTeam] Attempting to add user 3 to team 101 by authUser 3 (DEPARTMENT_SUPERVISOR)

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:294:13)

    console.log
      [TeamsService.findOne] Called for team ID: 101 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 101 found: Concurrent Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 101 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 101 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 101 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.addMemberToTeam] Adding user 3 as an active member to new team 101.

      at src/modules/teams/services/teams.service.ts:371:15

    console.log
      [TeamsService.addMemberToTeam] User 3 successfully added to team 101 and membership history created.

      at src/modules/teams/services/teams.service.ts:379:15

    console.log
      [TeamsService.addMemberToTeam] Transaction completed. Fetching and returning updated team info for team 101.

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:387:13)

    console.log
      [TeamsService.findOne] Called for team ID: 101 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 101 found: Concurrent Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 101 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 101 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [TeamsService.findOne] Team 101 found: Concurrent Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 101 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 101 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 101 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.addMemberToTeam] User 3 is already an active member of team 101. No database changes needed within the transaction.

      at src/modules/teams/services/teams.service.ts:346:17

    console.log
      [TeamsService.addMemberToTeam] Transaction completed. Fetching and returning updated team info for team 101.

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:387:13)

    console.log
      [TeamsService.findOne] Called for team ID: 101 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 101 found: Concurrent Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 101 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 101 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [CONCURRENT_TEST] Received status codes: [ 201, 201 ]

      at Object.<anonymous> (test/team-management.e2e-spec.ts:472:15)

    console.log
      üßπ E2E test environment cleaned up

      at Object.<anonymous> (test/setup-e2e.ts:19:11)

[31m[Nest] 17844  - [39m28.05.2025 01:24:55 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 403 Final Response Payload: {"statusCode":403,"message":"Only system administrators, department supervisors, or the user themselves can update team assignments.","error":"ForbiddenException","timestamp":"2025-05-27T22:24:55.919Z","path":"/users/45/active-team"} Path: /users/45/active-team Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:55 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mForbiddenException: Only system administrators, department supervisors, or the user themselves can update team assignments.
    at UsersService.updateUserActiveTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\users\services\users.service.ts:278:13)
    at UsersController.updateActiveTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\users\controllers\users.controller.ts:203:49)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:38:29
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:55 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 400 Final Response Payload: {"statusCode":400,"message":"Team leader must be from the same department as the team.","error":"BadRequestException","timestamp":"2025-05-27T22:24:55.949Z","path":"/teams"} Path: /teams Method: POST[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:55 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mBadRequestException: Team leader must be from the same department as the team.
    at TeamsService.create (C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:121:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:56 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 400 Final Response Payload: {"statusCode":400,"message":"User must be from the same department as the team.","error":"BadRequestException","timestamp":"2025-05-27T22:24:56.085Z","path":"/users/46/active-team"} Path: /users/46/active-team Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:56 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mBadRequestException: User must be from the same department as the team.
    at UsersService.updateUserActiveTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\users\services\users.service.ts:318:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at UsersController.updateActiveTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\users\controllers\users.controller.ts:203:25)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:56 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 404 Final Response Payload: {"statusCode":404,"message":"Team with ID 999999 not found","error":"NotFoundException","timestamp":"2025-05-27T22:24:56.105Z","path":"/users/45/active-team"} Path: /users/45/active-team Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:56 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mNotFoundException: Team with ID 999999 not found
    at UsersService.updateUserActiveTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\users\services\users.service.ts:301:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at UsersController.updateActiveTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\users\controllers\users.controller.ts:203:25)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:56 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 404 Final Response Payload: {"statusCode":404,"message":"User with ID 999999 not found","error":"NotFoundException","timestamp":"2025-05-27T22:24:56.124Z","path":"/users/999999/active-team"} Path: /users/999999/active-team Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:56 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mNotFoundException: User with ID 999999 not found
    at UsersService.updateUserActiveTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\users\services\users.service.ts:286:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at UsersController.updateActiveTeam (C:\Users\furka\KentNabiz\apps\api\src\modules\users\controllers\users.controller.ts:203:25)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:56 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 401 Final Response Payload: {"statusCode":401,"message":"Unauthorized","error":"UnauthorizedException","timestamp":"2025-05-27T22:24:56.135Z","path":"/users/45/active-team"} Path: /users/45/active-team Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:56 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mUnauthorizedException: Unauthorized
    at JwtAuthGuard.handleRequest (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:60:30)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:44:124
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:83:24
    at allFailed (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:110:18)
    at attempt (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:183:28)
    at JwtStrategy.strategy.fail (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:314:9)
    at JwtStrategy.Object.<anonymous>.JwtStrategy.authenticate (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport-jwt@4.0.1\node_modules\passport-jwt\lib\strategy.js:96:21)
    at attempt (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:378:16)
    at authenticate (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:379:7)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:88:3
    at new Promise (<anonymous>)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:80:83
    at JwtAuthGuard.canActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:44:32)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
PASS test/users-team-assignment.e2e-spec.ts
  ‚óè Console

    console.log
      üß™ Setting up E2E test environment...

      at Object.<anonymous> (test/setup-e2e.ts:7:11)

    console.log
      ‚úÖ E2E test environment ready (using globally seeded data).

      at Object.<anonymous> (test/setup-e2e.ts:15:11)

    console.log
      [AuthHelper.generateToken] Creating token for user 4 (admin@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 4,
        "email": "admin@test.com",
        "roles": [
          "SYSTEM_ADMIN"
        ],
        "departmentId": null,
        "jti": "test-4-1748384695442"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384695443"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 2 (team.member@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 2,
        "email": "team.member@test.com",
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1,
        "jti": "test-2-1748384695444"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for UsersController.create on path /users

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /users to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [RolesGuard] Checking roles for UsersController.findOne on path /users/45

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /users/45 to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [RolesGuard] Checking roles for UsersController.updateUserRoles on path /users/45/roles

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /users/45/roles to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for UsersController.updateActiveTeam on path /users/45/active-team

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /users/45/active-team, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /users/45/active-team. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.getTeamMembers on path /teams/102/members

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/102/members, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/102/members. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 102 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 102 found: Assignment Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 102 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 102 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 102 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [RolesGuard] Checking roles for UsersController.getTeamHistory on path /users/45/team-history

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /users/45/team-history, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /users/45/team-history. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for UsersController.updateActiveTeam on path /users/45/active-team

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /users/45/active-team, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /users/45/active-team. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for UsersController.updateActiveTeam on path /users/45/active-team

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /users/45/active-team, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /users/45/active-team. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for UsersController.updateActiveTeam on path /users/45/active-team

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /users/45/active-team, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: TEAM_MEMBER

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 2 with roles [TEAM_MEMBER] has required role for /users/45/active-team. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /teams to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [RolesGuard] Checking roles for UsersController.create on path /users

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /users to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [RolesGuard] Checking roles for UsersController.updateActiveTeam on path /users/46/active-team

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /users/46/active-team to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [RolesGuard] Checking roles for UsersController.updateActiveTeam on path /users/45/active-team

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /users/45/active-team, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /users/45/active-team. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for UsersController.updateActiveTeam on path /users/999999/active-team

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /users/999999/active-team, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /users/999999/active-team. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for UsersController.remove on path /users/45

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /users/45 to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [RolesGuard] Checking roles for TeamsController.remove on path /teams/102

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /teams/102 to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [TeamsService.findOne] Called for team ID: 102 by authUser: 4 (admin@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 102 found: Assignment Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 4 (Roles: SYSTEM_ADMIN, Dept: null) on team 102 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] SYSTEM_ADMIN detected. Access granted.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:47:15)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 102 by authUser 4: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 4 (Roles: SYSTEM_ADMIN, Dept: null) on team 102 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] SYSTEM_ADMIN detected. Access granted.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:47:15)

    console.log
      üßπ E2E test environment cleaned up

      at Object.<anonymous> (test/setup-e2e.ts:19:11)

[31m[Nest] 17844  - [39m28.05.2025 01:24:57 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 403 Final Response Payload: {"statusCode":403,"message":"Insufficient permissions.","error":"ForbiddenException","timestamp":"2025-05-27T22:24:57.467Z","path":"/reports/94/assign-team/1"} Path: /reports/94/assign-team/1 Method: PATCH[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:57 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mForbiddenException: Insufficient permissions.
    at RolesGuard.canActivate (C:\Users\furka\KentNabiz\apps\api\src\modules\auth\guards\roles.guard.ts:59:13)
    at GuardsConsumer.tryActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\guards\guards-consumer.js:15:34)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at canActivateFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:135:33)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:42:31
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-proxy.js:9:17[39m
HttpExceptionFilter
PASS test/reports-workflow.e2e-spec.ts
  ‚óè Console

    console.log
      üß™ Setting up E2E test environment...

      at Object.<anonymous> (test/setup-e2e.ts:7:11)

    console.log
      ‚úÖ E2E test environment ready (using globally seeded data).

      at Object.<anonymous> (test/setup-e2e.ts:15:11)

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384697065"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.create on path /reports

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports, Required Roles: CITIZEN, SYSTEM_ADMIN, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 1 with roles [CITIZEN] has required role for /reports. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384697210"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.findOne on path /reports/94

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/94, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, CITIZEN, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 1 with roles [CITIZEN] has required role for /reports/94. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [findOne] AuthUser: {"sub":1,"email":"citizen@test.com","roles":["CITIZEN"],"departmentId":null,"jti":"test-1-1748384697210"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":94,"title":"Pothole on Main Street","description":"Large pothole causing traffic issues","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"OPEN","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.114Z","updatedAt":"2025-05-27T19:24:57.092Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":1,"email":"citizen@test.com","roles":["CITIZEN"],"departmentId":null,"jti":"test-1-1748384697210"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":94,"title":"Pothole on Main Street","description":"Large pothole causing traffic issues","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"OPEN","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.114Z","updatedAt":"2025-05-27T19:24:57.092Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384697242"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.findAll on path /reports?page=1&limit=10&status=OPEN&reportType=POTHOLE

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports?page=1&limit=10&status=OPEN&reportType=POTHOLE, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports?page=1&limit=10&status=OPEN&reportType=POTHOLE. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384697283"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.findNearby on path /reports/nearby?latitude=41.0&longitude=29.0&radius=5000

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/nearby?latitude=41.0&longitude=29.0&radius=5000, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, CITIZEN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/nearby?latitude=41.0&longitude=29.0&radius=5000. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384697321"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.assignReportToTeam on path /reports/94/assign-team/1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/94/assign-team/1, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/94/assign-team/1. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 1 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 1 found: Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 1 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 1 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [ReportsService.assignReportToTeam] New assignment created: ID 65, Report ID 94, Team ID 1, AcceptedAt: 2025-05-27T22:24:57.372Z

      at ReportsService.assignReportToTeam (src/modules/reports/services/reports.service.ts:897:15)

    console.log
      [ReportsService.assignReportToTeam] Report 94 status updated from OPEN to IN_REVIEW, subStatus to NONE.

      at ReportsService.assignReportToTeam (src/modules/reports/services/reports.service.ts:911:17)

    console.log
      [findOne] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697321"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":94,"title":"Pothole on Main Street","description":"Large pothole causing traffic issues","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.114Z","updatedAt":"2025-05-27T19:24:57.361Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":65,"reportId":94,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.372Z","acceptedAt":"2025-05-27T22:24:57.372Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697321"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":94,"title":"Pothole on Main Street","description":"Large pothole causing traffic issues","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.114Z","updatedAt":"2025-05-27T19:24:57.361Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":65,"reportId":94,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.372Z","acceptedAt":"2025-05-27T22:24:57.372Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384697405"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.assignReportToUser on path /reports/94/assign-user/3

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/94/assign-user/3, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/94/assign-user/3. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697405"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":94,"title":"Pothole on Main Street","description":"Large pothole causing traffic issues","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.114Z","updatedAt":"2025-05-27T19:24:57.361Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":65,"reportId":94,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.372Z","acceptedAt":"2025-05-27T22:24:57.372Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: assign

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: assign

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [findOne] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697405"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":94,"title":"Pothole on Main Street","description":"Large pothole causing traffic issues","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.114Z","updatedAt":"2025-05-27T19:24:57.361Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":65,"reportId":94,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"CANCELLED","assignedAt":"2025-05-27T22:24:57.372Z","acceptedAt":"2025-05-27T22:24:57.372Z","completedAt":null,"rejectedAt":null,"cancelledAt":"2025-05-27T22:24:57.426Z","assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}},{"id":66,"reportId":94,"assigneeType":"USER","assigneeUserId":3,"assigneeTeamId":null,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.432Z","acceptedAt":null,"completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":{"id":3,"email":"supervisor@test.com","fullName":"Test Supervisor","phoneNumber":null,"avatar":null,"roles":["DEPARTMENT_SUPERVISOR"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":1,"activeTeamId":101,"createdAt":"2025-05-27T10:03:55.588Z","updatedAt":"2025-05-27T19:24:54.494Z"},"assigneeTeam":null}],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697405"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":94,"title":"Pothole on Main Street","description":"Large pothole causing traffic issues","location":{"type":"Point","coordinates":[29,41]},"address":"123 Main Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.114Z","updatedAt":"2025-05-27T19:24:57.361Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":65,"reportId":94,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"CANCELLED","assignedAt":"2025-05-27T22:24:57.372Z","acceptedAt":"2025-05-27T22:24:57.372Z","completedAt":null,"rejectedAt":null,"cancelledAt":"2025-05-27T22:24:57.426Z","assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}},{"id":66,"reportId":94,"assigneeType":"USER","assigneeUserId":3,"assigneeTeamId":null,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.432Z","acceptedAt":null,"completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":{"id":3,"email":"supervisor@test.com","fullName":"Test Supervisor","phoneNumber":null,"avatar":null,"roles":["DEPARTMENT_SUPERVISOR"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":1,"activeTeamId":101,"createdAt":"2025-05-27T10:03:55.588Z","updatedAt":"2025-05-27T19:24:54.494Z"},"assigneeTeam":null}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384697461"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.assignReportToTeam on path /reports/94/assign-team/1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/94/assign-team/1, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.warn
      [RolesGuard] User 1 with roles [CITIZEN] does NOT have required roles [DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER] for /reports/94/assign-team/1. Denying access.

    [0m [90m 54 |[39m
     [90m 55 |[39m     [36mif[39m ([33m![39mhasRequiredRole) {
    [31m[1m>[22m[39m[90m 56 |[39m       console[33m.[39mwarn(
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 57 |[39m         [32m`[RolesGuard] User ${user.sub} with roles [${user.roles.join(', ')}] does NOT have required roles [${requiredRoles.join(', ')}] for ${request.url}. Denying access.`[39m
     [90m 58 |[39m       )[33m;[39m
     [90m 59 |[39m       [36mthrow[39m [36mnew[39m [33mForbiddenException[39m([32m'Insufficient permissions.'[39m)[33m;[39m[0m

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:56:15)
      at GuardsConsumer.tryActivate (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/guards/guards-consumer.js:15:34)
      at canActivateFn (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:135:33)
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:42:31
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-proxy.js:9:17

    console.log
      [AuthHelper.generateToken] Creating token for user 1 (citizen@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 1,
        "email": "citizen@test.com",
        "roles": [
          "CITIZEN"
        ],
        "departmentId": null,
        "jti": "test-1-1748384697476"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.create on path /reports

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports, Required Roles: CITIZEN, SYSTEM_ADMIN, User Roles: CITIZEN

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 1 with roles [CITIZEN] has required role for /reports. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384697536"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.assignReportToTeam on path /reports/95/assign-team/1

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/95/assign-team/1, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/95/assign-team/1. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 1 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 1 found: Test Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 1 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 1 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [ReportsService.assignReportToTeam] New assignment created: ID 67, Report ID 95, Team ID 1, AcceptedAt: 2025-05-27T22:24:57.581Z

      at ReportsService.assignReportToTeam (src/modules/reports/services/reports.service.ts:897:15)

    console.log
      [ReportsService.assignReportToTeam] Report 95 status updated from OPEN to IN_REVIEW, subStatus to NONE.

      at ReportsService.assignReportToTeam (src/modules/reports/services/reports.service.ts:911:17)

    console.log
      [findOne] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697536"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":95,"title":"Team Member Test Report","description":"Report for testing team member status updates","location":{"type":"Point","coordinates":[29,41]},"address":"456 Team Test Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.493Z","updatedAt":"2025-05-27T19:24:57.570Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":67,"reportId":95,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.581Z","acceptedAt":"2025-05-27T22:24:57.581Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697536"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":95,"title":"Team Member Test Report","description":"Report for testing team member status updates","location":{"type":"Point","coordinates":[29,41]},"address":"456 Team Test Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.493Z","updatedAt":"2025-05-27T19:24:57.570Z","resolvedAt":null,"subStatus":null,"supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":67,"reportId":95,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.581Z","acceptedAt":"2025-05-27T22:24:57.581Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 2 (team.member@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 2,
        "email": "team.member@test.com",
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1,
        "jti": "test-2-1748384697613"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.updateStatus on path /reports/95/status

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/95/status, Required Roles: DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN, User Roles: TEAM_MEMBER

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 2 with roles [TEAM_MEMBER] has required role for /reports/95/status. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [ReportsService.updateStatus] Entry - Report ID: 95, User ID: 2, User Email: team.member@test.com, User Active Team ID: 1, New Status: IN_PROGRESS, New SubStatus: undefined

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:344:13)

    console.log
      [ReportsService.updateStatus] TEAM_MEMBER (ID: 2, ActiveTeamID: 1) attempting to update status for report 95.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:356:15)

    console.log
      [ReportsService.updateStatus] Report assignments for report 95 (for active check): [{"id":67,"reportId":95,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.581Z","acceptedAt":"2025-05-27T22:24:57.581Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:360:15)

    console.log
      [ReportsService.updateStatus] Checking assignment ID 67: assigneeType=TEAM, assigneeUserId=null, assigneeTeamId=1, status=ACTIVE, acceptedAt=2025-05-27T22:24:57.581Z, isUserMatch=false, isTeamMatch=true, isActive=true, isAccepted=true

      at src/modules/reports/services/reports.service.ts:375:19
          at Array.some (<anonymous>)

    console.log
      [ReportsService.updateStatus] TEAM_MEMBER hasActiveAssignment: true for report 95. User: 2, ActiveTeam: 1

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:389:15)

    console.log
      [ReportsService.updateStatus] ABAC Check - User: 2, Report: 95, NextStatus: IN_PROGRESS

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:408:13)

    console.log
      [ReportsService.updateStatus] UserForAbility: {
        "id": 2,
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:411:13)

    console.log
      [ReportsService.updateStatus] ReportForAuthCheck: {
        "id": 95,
        "status": "IN_REVIEW",
        "subStatus": null,
        "currentDepartmentId": 1,
        "userId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:415:13)

    console.log
      [ReportsService.updateStatus] Checking Action.Update permission

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:465:15)

    console.log
      [ReportsService.updateStatus] Transaction started for report 95.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:479:15)

    console.log
      [ReportsService.updateStatus] Locked report 95 and its relations loaded within transaction.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:494:15)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":2,"email":"team.member@test.com","roles":["TEAM_MEMBER"],"departmentId":1,"activeTeamId":1,"jti":"test-2-1748384697613"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":95,"title":"Team Member Test Report","description":"Report for testing team member status updates","location":{"type":"Point","coordinates":[29,41]},"address":"456 Team Test Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_REVIEW","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.493Z","updatedAt":"2025-05-27T19:24:57.570Z","resolvedAt":null,"subStatus":null,"supportCount":0,"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"assignments":[{"id":67,"reportId":95,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.581Z","acceptedAt":"2025-05-27T22:24:57.581Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: change_status

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [ReportsService.updateStatus] Transaction committed for report 95.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:625:15)

    console.log
      [ReportsService.updateStatus] Releasing query runner for report 95.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:646:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 2 (team.member@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 2,
        "email": "team.member@test.com",
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1,
        "jti": "test-2-1748384697686"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.updateStatus on path /reports/95/status

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/95/status, Required Roles: DEPARTMENT_SUPERVISOR, TEAM_MEMBER, SYSTEM_ADMIN, User Roles: TEAM_MEMBER

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 2 with roles [TEAM_MEMBER] has required role for /reports/95/status. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [ReportsService.updateStatus] Entry - Report ID: 95, User ID: 2, User Email: team.member@test.com, User Active Team ID: 1, New Status: DONE, New SubStatus: PENDING_APPROVAL

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:344:13)

    console.log
      [ReportsService.updateStatus] TEAM_MEMBER (ID: 2, ActiveTeamID: 1) attempting to update status for report 95.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:356:15)

    console.log
      [ReportsService.updateStatus] Report assignments for report 95 (for active check): [{"id":67,"reportId":95,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.581Z","acceptedAt":"2025-05-27T22:24:57.581Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:360:15)

    console.log
      [ReportsService.updateStatus] Checking assignment ID 67: assigneeType=TEAM, assigneeUserId=null, assigneeTeamId=1, status=ACTIVE, acceptedAt=2025-05-27T22:24:57.581Z, isUserMatch=false, isTeamMatch=true, isActive=true, isAccepted=true

      at src/modules/reports/services/reports.service.ts:375:19
          at Array.some (<anonymous>)

    console.log
      [ReportsService.updateStatus] TEAM_MEMBER hasActiveAssignment: true for report 95. User: 2, ActiveTeam: 1

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:389:15)

    console.log
      [ReportsService.updateStatus] ABAC Check - User: 2, Report: 95, NextStatus: DONE

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:408:13)

    console.log
      [ReportsService.updateStatus] UserForAbility: {
        "id": 2,
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:411:13)

    console.log
      [ReportsService.updateStatus] ReportForAuthCheck: {
        "id": 95,
        "status": "IN_PROGRESS",
        "subStatus": null,
        "currentDepartmentId": 1,
        "userId": 1
      }

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:415:13)

    console.log
      [ReportsService.updateStatus] Checking Action.CompleteWork permission for TEAM_MEMBER

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:441:15)

    console.log
      [ReportsService.updateStatus] Transaction started for report 95.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:479:15)

    console.log
      [ReportsService.updateStatus] Locked report 95 and its relations loaded within transaction.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:494:15)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":2,"email":"team.member@test.com","roles":["TEAM_MEMBER"],"departmentId":1,"activeTeamId":1,"jti":"test-2-1748384697686"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":95,"title":"Team Member Test Report","description":"Report for testing team member status updates","location":{"type":"Point","coordinates":[29,41]},"address":"456 Team Test Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_PROGRESS","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.493Z","updatedAt":"2025-05-27T19:24:57.648Z","resolvedAt":null,"subStatus":null,"supportCount":0,"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"assignments":[{"id":67,"reportId":95,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.581Z","acceptedAt":"2025-05-27T22:24:57.581Z","completedAt":null,"rejectedAt":null,"cancelledAt":null}]}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: change_status

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [ReportsService.updateStatus] Transaction committed for report 95.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:625:15)

    console.log
      [ReportsService.updateStatus] Releasing query runner for report 95.

      at ReportsService.updateStatus (src/modules/reports/services/reports.service.ts:646:17)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384697771"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for ReportsController.getStatusHistory on path /reports/95/status-history

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /reports/95/status-history, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, TEAM_MEMBER, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /reports/95/status-history. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [findOne] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697771"}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:212:13)

    console.log
      [findOne] Report fetched: {"id":95,"title":"Team Member Test Report","description":"Report for testing team member status updates","location":{"type":"Point","coordinates":[29,41]},"address":"456 Team Test Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_PROGRESS","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.493Z","updatedAt":"2025-05-27T19:24:57.728Z","resolvedAt":null,"subStatus":"PENDING_APPROVAL","supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":67,"reportId":95,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.581Z","acceptedAt":"2025-05-27T22:24:57.581Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.findOne (src/modules/reports/services/reports.service.ts:214:13)

    console.log
      [canUserPerformActionOnReport] AuthUser: {"sub":3,"email":"supervisor@test.com","roles":["DEPARTMENT_SUPERVISOR"],"departmentId":1,"jti":"test-3-1748384697771"}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:82:13)

    console.log
      [canUserPerformActionOnReport] Report: {"id":95,"title":"Team Member Test Report","description":"Report for testing team member status updates","location":{"type":"Point","coordinates":[29,41]},"address":"456 Team Test Street, Istanbul","reportType":"POTHOLE","categoryId":null,"status":"IN_PROGRESS","currentDepartmentId":1,"resolutionNotes":null,"rejectionReason":null,"userId":1,"closedByUserId":null,"createdAt":"2025-05-27T19:24:57.493Z","updatedAt":"2025-05-27T19:24:57.728Z","resolvedAt":null,"subStatus":"PENDING_APPROVAL","supportCount":0,"reportMedias":[],"currentDepartment":{"id":1,"code":"GENERAL","name":"Genel Birim","description":"Sƒ±nƒ±flandƒ±rƒ±lmamƒ±≈ü ≈üikayetlerin ilk y√∂nlendirildiƒüi birim","isActive":true,"responsibleReportTypes":["OTHER"],"createdAt":"2025-05-27T10:03:54.960Z","updatedAt":"2025-05-27T10:03:54.960Z"},"user":{"id":1,"email":"citizen@test.com","fullName":"Test Citizen","phoneNumber":null,"avatar":null,"roles":["CITIZEN"],"isEmailVerified":true,"password":"$2b$10$nQc62lX7SdyeZ9xgeieSCeNRPNxzgv4gefiLzDw4DWaGODpleMCOq","emailVerificationToken":null,"passwordResetToken":null,"passwordResetExpires":null,"lastLoginAt":null,"departmentId":null,"activeTeamId":null,"createdAt":"2025-05-27T10:03:55.519Z","updatedAt":"2025-05-27T10:03:55.638Z"},"assignments":[{"id":67,"reportId":95,"assigneeType":"TEAM","assigneeUserId":null,"assigneeTeamId":1,"assignedById":3,"status":"ACTIVE","assignedAt":"2025-05-27T22:24:57.581Z","acceptedAt":"2025-05-27T22:24:57.581Z","completedAt":null,"rejectedAt":null,"cancelledAt":null,"assigneeUser":null,"assigneeTeam":{"id":1,"name":"Test Team","departmentId":1,"teamLeaderId":null,"status":"AVAILABLE","baseLocation":null,"currentLocation":null,"lastLocationUpdate":null}}],"category":null}

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:83:13)

    console.log
      [canUserPerformActionOnReport] Action: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:84:13)

    console.log
      [canUserPerformActionOnReport] DEPARTMENT_SUPERVISOR check

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:124:15)

    console.log
      [canUserPerformActionOnReport] Report Dept ID: 1, User Dept ID: 1

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:125:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Dept Mismatch: false

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:132:15)

    console.log
      [canUserPerformActionOnReport] Supervisor Action Allowed: view

      at ReportsService.canUserPerformActionOnReport (src/modules/reports/services/reports.service.ts:140:17)

    console.log
      üßπ E2E test environment cleaned up

      at Object.<anonymous> (test/setup-e2e.ts:19:11)

[31m[Nest] 17844  - [39m28.05.2025 01:24:59 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 403 Final Response Payload: {"statusCode":403,"message":"Insufficient permissions.","error":"ForbiddenException","timestamp":"2025-05-27T22:24:59.213Z","path":"/teams"} Path: /teams Method: POST[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:59 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mForbiddenException: Insufficient permissions.
    at RolesGuard.canActivate (C:\Users\furka\KentNabiz\apps\api\src\modules\auth\guards\roles.guard.ts:59:13)
    at GuardsConsumer.tryActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\guards\guards-consumer.js:15:34)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at canActivateFn (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:135:33)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-execution-context.js:42:31
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11\node_modules\@nestjs\core\router\router-proxy.js:9:17[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:59 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 401 Final Response Payload: {"statusCode":401,"message":"Unauthorized","error":"UnauthorizedException","timestamp":"2025-05-27T22:24:59.250Z","path":"/teams/104"} Path: /teams/104 Method: GET[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:59 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mUnauthorizedException: Unauthorized
    at JwtAuthGuard.handleRequest (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:60:30)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:44:124
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:83:24
    at allFailed (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:110:18)
    at attempt (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:183:28)
    at JwtStrategy.strategy.fail (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:314:9)
    at JwtStrategy.Object.<anonymous>.JwtStrategy.authenticate (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport-jwt@4.0.1\node_modules\passport-jwt\lib\strategy.js:96:21)
    at attempt (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:378:16)
    at authenticate (C:\Users\furka\KentNabiz\node_modules\.pnpm\passport@0.7.0\node_modules\passport\lib\middleware\authenticate.js:379:7)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:88:3
    at new Promise (<anonymous>)
    at C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:80:83
    at JwtAuthGuard.canActivate (C:\Users\furka\KentNabiz\node_modules\.pnpm\@nestjs+passport@11.0.5_@ne_33170d5ddf27925c71f4bc267b90bbe1\node_modules\@nestjs\passport\dist\auth.guard.js:44:32)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
[31m[Nest] 17844  - [39m28.05.2025 01:24:59 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mHTTP Status: 404 Final Response Payload: {"statusCode":404,"message":"Team with ID 104 not found.","error":"NotFoundException","timestamp":"2025-05-27T22:24:59.371Z","path":"/teams/104"} Path: /teams/104 Method: GET[39m
[31m[Nest] 17844  - [39m28.05.2025 01:24:59 [31m  ERROR[39m [38;5;3m[HttpExceptionFilter] [39m[31mNotFoundException: Team with ID 104 not found.
    at TeamsService.findOne (C:\Users\furka\KentNabiz\apps\api\src\modules\teams\services\teams.service.ts:202:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
HttpExceptionFilter
PASS test/teams-workflow.e2e-spec.ts
  ‚óè Console

    console.log
      üß™ Setting up E2E test environment...

      at Object.<anonymous> (test/setup-e2e.ts:7:11)

    console.log
      ‚úÖ E2E test environment ready (using globally seeded data).

      at Object.<anonymous> (test/setup-e2e.ts:15:11)

    console.log
      [AuthHelper.generateToken] Creating token for user 4 (admin@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 4,
        "email": "admin@test.com",
        "roles": [
          "SYSTEM_ADMIN"
        ],
        "departmentId": null,
        "jti": "test-4-1748384698886"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 3 (supervisor@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 3,
        "email": "supervisor@test.com",
        "roles": [
          "DEPARTMENT_SUPERVISOR"
        ],
        "departmentId": 1,
        "jti": "test-3-1748384698887"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [AuthHelper.generateToken] Creating token for user 2 (team.member@test.com)

      at AuthHelper.generateToken (test/auth-helper.ts:57:13)

    console.log
      [AuthHelper.generateToken] Payload: {
        "sub": 2,
        "email": "team.member@test.com",
        "roles": [
          "TEAM_MEMBER"
        ],
        "departmentId": 1,
        "activeTeamId": 1,
        "jti": "test-2-1748384698888"
      }

      at AuthHelper.generateToken (test/auth-helper.ts:58:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findOne on path /teams/104

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/104, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/104. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.update on path /teams/104

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/104, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/104. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [RolesGuard] Checking roles for TeamsController.findAll on path /teams?page=1&limit=10

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams?page=1&limit=10, Required Roles: SYSTEM_ADMIN, DEPARTMENT_SUPERVISOR, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams?page=1&limit=10. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.addMemberToTeamWithBody on path /teams/104/members

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/104/members, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/104/members. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.addMemberToTeam] Attempting to add user 3 to team 104 by authUser 3 (DEPARTMENT_SUPERVISOR)

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:294:13)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Updated Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.addMemberToTeam] User 3 is currently an active member of team 101. Removing from old team before adding to team 104.

      at src/modules/teams/services/teams.service.ts:356:17

    console.log
      [TeamsService.addMemberToTeam] User 3 removed from old team 101.

      at src/modules/teams/services/teams.service.ts:365:17

    console.log
      [TeamsService.addMemberToTeam] Adding user 3 as an active member to new team 104.

      at src/modules/teams/services/teams.service.ts:371:15

    console.log
      [TeamsService.addMemberToTeam] User 3 successfully added to team 104 and membership history created.

      at src/modules/teams/services/teams.service.ts:379:15

    console.log
      [TeamsService.addMemberToTeam] Transaction completed. Fetching and returning updated team info for team 104.

      at TeamsService.addMemberToTeam (src/modules/teams/services/teams.service.ts:387:13)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Updated Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.getTeamMembers on path /teams/104/members

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/104/members, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/104/members. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Updated Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [RolesGuard] Checking roles for TeamsController.updateMemberSpecializations on path /teams/104/members/3

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/104/members/3, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/104/members/3. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.removeMemberFromTeam on path /teams/104/members/3

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/104/members/3, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/104/members/3. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Updated Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'manage'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Updated Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 3 (Roles: DEPARTMENT_SUPERVISOR, Dept: 1) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] DEPARTMENT_SUPERVISOR in same department. Access granted for action 'view'.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:53:17)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 3: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.create on path /teams

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: TEAM_MEMBER

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.warn
      [RolesGuard] User 2 with roles [TEAM_MEMBER] does NOT have required roles [DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN] for /teams. Denying access.

    [0m [90m 54 |[39m
     [90m 55 |[39m     [36mif[39m ([33m![39mhasRequiredRole) {
    [31m[1m>[22m[39m[90m 56 |[39m       console[33m.[39mwarn(
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 57 |[39m         [32m`[RolesGuard] User ${user.sub} with roles [${user.roles.join(', ')}] does NOT have required roles [${requiredRoles.join(', ')}] for ${request.url}. Denying access.`[39m
     [90m 58 |[39m       )[33m;[39m
     [90m 59 |[39m       [36mthrow[39m [36mnew[39m [33mForbiddenException[39m([32m'Insufficient permissions.'[39m)[33m;[39m[0m

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:56:15)
      at GuardsConsumer.tryActivate (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/guards/guards-consumer.js:15:34)
      at canActivateFn (../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:135:33)
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-execution-context.js:42:31
      at ../../node_modules/.pnpm/@nestjs+core@11.0.12_@nestj_b33b5792bd9420a7838e1168c93cfe11/node_modules/@nestjs/core/router/router-proxy.js:9:17

    console.log
      [RolesGuard] Checking roles for TeamsController.findOne on path /teams/104

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /teams/104 to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 4 (admin@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Updated Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 4 (Roles: SYSTEM_ADMIN, Dept: null) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] SYSTEM_ADMIN detected. Access granted.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:47:15)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 4: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.updateTeamLocation on path /teams/104/location

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/104/location, Required Roles: DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/104/location. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.findNearbyTeams on path /teams/nearby?lat=29.0&lng=41.0&radius=1000

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/nearby?lat=29.0&lng=41.0&radius=1000, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/nearby?lat=29.0&lng=41.0&radius=1000. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [RolesGuard] Checking roles for TeamsController.remove on path /teams/104

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] SYSTEM_ADMIN access granted for /teams/104 to user 4

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:21:15)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 4 (admin@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.log
      [TeamsService.findOne] Team 104 found: Updated Emergency Response Team. Department: 1

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:204:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 4 (Roles: SYSTEM_ADMIN, Dept: null) on team 104 (Dept: 1) for action: view

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] SYSTEM_ADMIN detected. Access granted.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:47:15)

    console.log
      [TeamsService.findOne] Authorization check for 'view' on team 104 by authUser 4: true

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:210:13)

    console.log
      [isAuthorizedForTeamOperation] Checking auth for user 4 (Roles: SYSTEM_ADMIN, Dept: null) on team 104 (Dept: 1) for action: manage

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:42:13)

    console.log
      [isAuthorizedForTeamOperation] SYSTEM_ADMIN detected. Access granted.

      at TeamsService.isAuthorizedForTeamOperation (src/modules/teams/services/teams.service.ts:47:15)

    console.log
      [RolesGuard] Checking roles for TeamsController.findOne on path /teams/104

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:17:13)

    console.log
      [RolesGuard] Path: /teams/104, Required Roles: TEAM_MEMBER, DEPARTMENT_SUPERVISOR, SYSTEM_ADMIN, User Roles: DEPARTMENT_SUPERVISOR

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:33:13)

    console.log
      [RolesGuard] User 3 with roles [DEPARTMENT_SUPERVISOR] has required role for /teams/104. Access granted.

      at RolesGuard.canActivate (src/modules/auth/guards/roles.guard.ts:61:13)

    console.log
      [TeamsService.findOne] Called for team ID: 104 by authUser: 3 (supervisor@test.com)

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:184:13)

    console.warn
      [TeamsService.findOne] Team with ID 104 not found in repository.

    [0m [90m 199 |[39m
     [90m 200 |[39m     [36mif[39m ([33m![39mteam) {
    [31m[1m>[22m[39m[90m 201 |[39m       console[33m.[39mwarn([32m`[TeamsService.findOne] Team with ID ${id} not found in repository.`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 202 |[39m       [36mthrow[39m [36mnew[39m [33mNotFoundException[39m([32m`Team with ID ${id} not found.`[39m)[33m;[39m
     [90m 203 |[39m     }
     [90m 204 |[39m     console[33m.[39mlog([0m

      at TeamsService.findOne (src/modules/teams/services/teams.service.ts:201:15)

    console.log
      üßπ E2E test environment cleaned up

      at Object.<anonymous> (test/setup-e2e.ts:19:11)


Test Suites: 5 passed, 5 total
Tests:       86 passed, 86 total
Snapshots:   0 total
Time:        12.609 s
Ran all test suites.
üßπ Global E2E Teardown completed.
